{% extends "base.html" %}

{% block title %}JSON Log Viewer - SecureBank{% endblock %}

{% block extra_css %}
<style>
    .json-log-container {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
        padding: 20px;
        border-radius: 8px;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .json-log-line {
        white-space: pre-wrap;
        word-break: break-all;
        margin-bottom: 5px;
        border-bottom: 1px solid #333;
        padding: 5px 0;
        cursor: pointer;
    }
    
    .json-log-line:hover {
        background-color: #2d2d2d;
    }
    
    .json-key {
        color: #9cdcfe;
    }
    
    .json-string {
        color: #ce9178;
    }
    
    .json-number {
        color: #b5cea8;
    }
    
    .json-boolean {
        color: #569cd6;
    }
    
    .json-null {
        color: #569cd6;
    }
    
    .log-level-ERROR {
        border-left: 4px solid #f48771;
    }
    
    .log-level-WARNING {
        border-left: 4px solid #cca700;
    }
    
    .log-level-INFO {
        border-left: 4px solid #75beff;
    }
    
    .log-level-DEBUG {
        border-left: 4px solid #9cdcfe;
    }
    
    .filter-bar {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .syntax-highlighter {
        margin: 0;
        padding: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-chart-line me-2"></i>JSON Log Viewer</h2>
            <p class="text-muted">SIEM-compatible logs in JSON format</p>
        </div>
    </div>
    
    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Log Type</label>
                <select class="form-select" id="logType">
                    <option value="application">Application Logs</option>
                    <option value="transactions">Transaction Logs</option>
                    <option value="audit">Audit Logs</option>
                    <option value="errors">Error Logs</option>
                    <option value="performance">Performance Logs</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Level</label>
                <select class="form-select" id="logLevel">
                    <option value="ALL">All Levels</option>
                    <option value="ERROR">ERROR</option>
                    <option value="WARNING">WARNING</option>
                    <option value="INFO">INFO</option>
                    <option value="DEBUG">DEBUG</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Lines</label>
                <select class="form-select" id="logLines">
                    <option value="100">Last 100</option>
                    <option value="500">Last 500</option>
                    <option value="1000">Last 1000</option>
                    <option value="5000">Last 5000</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="loadLogs()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
    
    <!-- JSON Log Display -->
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="fas fa-terminal me-2"></i><span id="currentLogType">application.json</span></span>
            <span>
                <button class="btn btn-sm btn-outline-light me-2" onclick="copyLogs()">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-sm btn-outline-light" onclick="downloadLogs()">
                    <i class="fas fa-download"></i>
                </button>
            </span>
        </div>
        <div class="card-body p-0">
            <div class="json-log-container" id="logDisplay">
                Loading logs...
            </div>
        </div>
    </div>
</div>

<script>
let currentLogs = [];

function syntaxHighlight(json) {
    if (typeof json !== 'string') {
        json = JSON.stringify(json, null, 2);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'json-number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'json-key';
            } else {
                cls = 'json-string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
        } else if (/null/.test(match)) {
            cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

function loadLogs() {
    const logType = document.getElementById('logType').value;
    const logLevel = document.getElementById('logLevel').value;
    const lines = document.getElementById('logLines').value;
    
    document.getElementById('currentLogType').textContent = logType + '.json';
    document.getElementById('logDisplay').innerHTML = 'Loading logs...';
    
    fetch(`/admin/json-logs?type=${logType}&lines=${lines}`)
        .then(response => response.json())
        .then(data => {
            currentLogs = data.logs || [];
            const display = document.getElementById('logDisplay');
            
            if (currentLogs.length === 0) {
                display.innerHTML = '<div class="text-center text-muted py-5">No logs found</div>';
                return;
            }
            
            let html = '';
            currentLogs.forEach(log => {
                const level = log.level || 'INFO';
                const levelClass = `log-level-${level}`;
                const formattedJson = syntaxHighlight(JSON.stringify(log, null, 2));
                html += `<div class="json-log-line ${levelClass}" onclick="expandLog(this)">${formattedJson}</div>`;
            });
            
            display.innerHTML = html;
        })
        .catch(error => {
            document.getElementById('logDisplay').innerHTML = `<div class="text-danger">Error loading logs: ${error}</div>`;
        });
}

function expandLog(element) {
    // Toggle full view
    element.classList.toggle('expanded');
}

function copyLogs() {
    const text = currentLogs.map(l => JSON.stringify(l)).join('\n');
    navigator.clipboard.writeText(text).then(() => {
        alert('Logs copied to clipboard');
    });
}

function downloadLogs() {
    const logType = document.getElementById('logType').value;
    const blob = new Blob([currentLogs.map(l => JSON.stringify(l)).join('\n')], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${logType}_${new Date().toISOString()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Auto-refresh every 30 seconds
setInterval(loadLogs, 30000);

// Initial load
loadLogs();
</script>
{% endblock %}